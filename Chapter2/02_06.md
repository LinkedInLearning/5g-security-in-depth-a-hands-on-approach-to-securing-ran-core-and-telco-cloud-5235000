02_06 Lab: Investigating Authentication Flows & Threat Detection

🎯 Learning Goal

"Investigate authentication call flows through live attack simulations and packet analysis to understand TTPs and improve incident response."

🛠️ Prerequisites

A working Open5GS 5G Core setup (preferably in Kubernetes)

A functional UERANSIM (UE + gNB simulator)

Access to tcpdump, Wireshark, and Scapy


Step 1: Capture 5G Authentication Flows

Start UERANSIM UE session to initiate registration and PDU session.

./nr-ue -c ../config/open5gs-ue.yaml

Capture packets on the AMF pod:

kubectl exec -it -n open5gs <amf-pod> -- tcpdump -i any -w /tmp/amf-auth.pcap port 38412

Download the PCAP to your local machine:

kubectl cp open5gs/<amf-pod>:/tmp/amf-auth.pcap ./amf-auth.pcap

Open it in Wireshark with filter:

ngap || nas-5gs

🔬 Step 2: Analyze Security Parameters

Message

Focus Parameters

Registration Request/Accept

SUPI/SUCI, GUTI, 5GS Security Context

Authentication Request/Response

RAND, AUTN, RES*, KSEAF

Initial Context Setup Request

UE NGAP ID, NAS Security Parameters, Algorithms

PDU Session Establishment Req/Resp

PDU Session ID, QoS, DNN, S-NSSAI

🔁 Step 3: Replay Attack Simulation

Use Scapy to simulate a replay:

from scapy.all import *

payload = bytes.fromhex("<PASTE_YOUR_NAS_HEX_PAYLOAD>")
pkt = IP(dst="<AMF_IP>") / SCTP(dport=38412, sport=3456) / Raw(load=payload)
send(pkt)

⚠️ Make sure you're using an unencrypted NAS message (e.g., Registration or Auth).

🕵️ Step 4: TTP Mapping Table

Parameter

Risk Example

TTP Mapping

SUPI/SUCI reuse

Replay of UE identity

Credential Access → Identity Impersonation

AUTN/RES* mismatch

Faked auth response

Defense Evasion → Protocol Manipulation

Duplicate UE NGAP ID

Zombie session replay

Persistence → Session Fixation

Reused PDU Session ID

Hijacked tunnel reuse

Initial Access → Tunneling Protocol Abuse

Unusual QoS/DNN

Suspicious data exfiltration

Exfiltration → Over Command & Control Channel

🧾 Expected Deliverables

✅ Annotated .pcap file with highlighted parameters

✅ A written report mapping captured data to MITRE FIGHT or ATT&CK TTPs

✅ (Optional) Scapy replay script or detection rule idea

🧰 Tools Used

Wireshark

tcpdump

Scapy

Open5GS

MITRE FIGHT

🚀 Suggested Extensions

Simulate Red vs. Blue: replay attack + detect using Open5GS logs or SIEM

Add alerting logic using Falco, Prometheus, or ELK



